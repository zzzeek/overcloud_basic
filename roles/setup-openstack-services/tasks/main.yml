
- name: set region names
  ini_file:
    path: /var/lib/config-data/puppet-generated/{{ item['filename'] }}
    section: "{{ item['section'] }}"
    option: "region_name"
    value: "region_{{ stack_name }}"
    backup: yes
  become: true
  with_items:
    - {"filename": "nova/etc/nova/nova.conf", "section": "keystone"}
    - {"filename": "nova/etc/nova/nova.conf", "section": "keystone_authtoken"}
# etc
#

- name: change DB url in keystone.conf
  lineinfile:
    path: /var/lib/config-data/puppet-generated/keystone/etc/keystone/keystone.conf
    regexp: ^connection=
    # TODO: need a new cnf file with an appropriate bind_address for this to work
    #line: connection=mysql+pymysql://keystone:stretch_keystone@{{ stretch_galera_vip }}/keystone?read_default_group=tripleo&read_default_file=/etc/my.cnf.d/tripleo.cnf
    line: connection=mysql+pymysql://keystone:stretch_keystone@{{ stretch_galera_vip }}/keystone
    backup: true
  become: true

- name: restart services!
  shell: docker restart {{ item }}
  become: true
  with_items:
    - keystone
    - memcached
    - nova_api
#    - nova_conductor
#    - nova_metadata
#    - glance_api
#    - cinder_api
#    - cinder_scheduler
#    - neutron_metadata_agent
#    - neutron_ovs_agent
#    - neutron_api
#    - heat_engine
