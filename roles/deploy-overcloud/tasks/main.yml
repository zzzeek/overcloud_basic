- name: set release number, hypervisor management address
  set_fact:
    release_numeric_version: "{{ release_numeric_versions[release_name] }}"
    management_ipv4_address: "{{ hostvars['hypervisor']['ansible_default_ipv4']['address'] }}"
  tags: always

- name: set up vlan
  import_tasks: setup_vlan.yml
  tags: setup_vlan

- name: Configure vbmc
  include_role:
    name: vbmc
  vars:
    vbmc_nodes: "{{ groups.get('overcloud_nodes', []) }}"
    vbmc_host: undercloud
  tags: 
    - install_vbmc
    - create_instackenv

# creating the instackenv requires some of the vbmc info.
# the infrared vbmc role currently is hardcoded to remove
# and re-add the vbmc nodes for each machine every time,
# but we only need to create instackenv once so it's not worth
# trying to make this more efficient
- name: create instackenv
  import_tasks: create_instackenv.yml
  tags: create_instackenv

- name: build heat config
  import_tasks: build_heat_config.yml
  tags: build_heat_config

- name: introspect nodes
  import_tasks: introspect_nodes.yml
  tags: introspect_nodes

- name: create flavors
  import_tasks: create_flavors.yml
  tags: create_flavors

- name: setup container stuff
  import_tasks: setup_containers.yml
  tags: prepare_containers

- name: deploy overcloud
  import_tasks: deploy_overcloud.yml
  tags: deploy_overcloud
