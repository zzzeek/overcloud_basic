# special trick to get a list, so we can use join() and avoid trailing comma
- name: get gcomm host entries
  set_fact: 
    gcomm_entry="{{ hostvars[item]['transport_ip_number'] }}"
    hostmap_entry="{{ hostvars[item]['pacemaker_node_name'] }}:{{ hostvars[item]['transport_ip_number'] }}"
  register: all_hosts_result
  with_items: "{{ groups['galera_nodes'] }}"

- name: create gcomm address, cluster_host_map
  set_fact:
      gcomm_address: "gcomm://{{ all_hosts_result.results | map(attribute='ansible_facts.gcomm_entry') | join(',') }}"
      cluster_host_map: "{{ all_hosts_result.results | map(attribute='ansible_facts.hostmap_entry') | join(';') }}"

# these next two maps we can do the easy way because we don't care about trailing semicolon
- name: create stack1 remote_node_map from stack2 nodes
  set_fact:
    remote_node_map: "{{ remote_node_map | default('') }}{{ hostvars[item]['pacemaker_node_name'] }}:root@{{ hostvars[item]['transport_ip_number'] }};"
  with_items: "{{ groups['galera_nodes'] | intersect(groups['stack2']) }}"
  when: "'stack1' in group_names"

- name: create stack2 remote_node_map from stack1 nodes
  set_fact:
    remote_node_map: "{{ remote_node_map | default('') }}{{ hostvars[item]['pacemaker_node_name'] }}:root@{{ hostvars[item]['transport_ip_number'] }};"
  with_items: "{{ groups['galera_nodes'] | intersect(groups['stack1']) }}"
  when: "'stack2' in group_names"

- name: set master overcloud weight
  set_fact:
    pc_weight: "2"
  when: "'stack1' in group_names"

- name: set follower overcloud weight
  set_fact:
    pc_weight: "1"
  when: "'stack2' in group_names"

- name: create all new kolla config
  shell: cp -R /var/lib/config-data/puppet-generated/mysql /var/lib/config-data/puppet-generated/mysql-stretch
  become: true

- name: change galera.cnf
  ini_file:
    path: /var/lib/config-data/puppet-generated/mysql-stretch/etc/my.cnf.d/galera.cnf
    section: "{{ item['section'] }}"
    option: "{{ item['key'] }}"
    value: "{{ item['value'] }}"
    backup: yes
  become: true
  with_items:
    - {"section": "mysqld", "key": "port", "value": "{{ galera_listen_port }}"}
    - {"section": "client", "key": "port", "value": "{{ galera_listen_port }}"}
    - {"section": "mysqld", "key": "bind-address", "value": "{{ transport_ip_number }}"}
    - {"section": "mysqld", "key": "wsrep_provider_options", "value": "gmcast.listen_addr=tcp://{{ transport_ip_number }}:4567;pc.weight={{ pc_weight }}"}
    - {"section": "mysqld", "key": "wsrep_sst_receive_address", "value": "{{ transport_ip_number }}"}
    - {"section": "mysqld", "key": "wsrep_cluster_address", "value": "{{ gcomm_address }}"}


# NOTE: the file seems to use root, maybe we should not assume that
- name: set clustercheck password
  lineinfile:
    path: /var/lib/config-data/puppet-generated/mysql-stretch/etc/sysconfig/clustercheck
    regexp: "^MYSQL_PASSWORD=.*"
    line: "MYSQL_PASSWORD='{{ galera_root_password }}'"
  become: true

